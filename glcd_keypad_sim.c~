#include <mega64a.h>
#include <delay.h>
#include <glcd.h>
#include <font5x7.h>
#include <stdio.h>
#include <string.h>

// ÈÇİÑ ÈÑÇí ÏÑíÇİÊ ÏÇÏå ÇÒ ãÇæá
char receive_buffer[100];

// ÊÇÈÚ ÓÇÏå ÈÑÇí ÇÑÓÇá ÏÓÊæÑÇÊ AT
void send_at_command(char *command)
{
    printf("%s\r\n", command);
}

void main(void)
{
    GLCDINIT_t glcd_init_data;

    // --- Çíä ÈÎÔ ãŞÏÇÑÏåí Çæáíå æÑÊåÇ æ USART ÇÓÊ ˜å ÇÒ ˜Ï ÎæÏÊÇä ˜í ÔÏå ---
    // --- æ ÕÍíÍ ÇÓÊ. äíÇÒí Èå ÊÛííÑ Âä äíÓÊ.                             ---
    DDRA=(0<<DDA7) | (0<<DDA6) | (0<<DDA5) | (0<<DDA4) | (0<<DDA3) | (0<<DDA2) | (0<<DDA1) | (0<<DDA0);
    PORTA=(0<<PORTA7) | (0<<PORTA6) | (0<<PORTA5) | (0<<PORTA4) | (0<<PORTA3) | (0<<PORTA2) | (0<<PORTA1) | (0<<PORTA0);
    DDRB=(0<<DDB7) | (0<<DDB6) | (0<<DDB5) | (0<<DDB4) | (0<<DDB3) | (0<<DDB2) | (0<<DDB1) | (0<<DDB0);
    PORTB=(1<<PORTB7) | (1<<PORTB6) | (1<<PORTB5) | (1<<PORTB4) | (0<<PORTB3) | (0<<PORTB2) | (0<<PORTB1) | (0<<PORTB0);
    DDRC=(0<<DDC7) | (0<<DDC6) | (0<<DDC5) | (0<<DDC4) | (0<<DDC3) | (1<<DDC2) | (1<<DDC1) | (1<<DDC0);
    PORTC=(1<<PORTC7) | (1<<PORTC6) | (1<<PORTC5) | (1<<PORTC4) | (0<<PORTC3) | (0<<PORTC2) | (0<<PORTC1) | (0<<PORTC0);
    DDRE=(0<<DDE7) | (0<<DDE6) | (1<<DDE5) | (1<<DDE4) | (1<<DDE3) | (1<<DDE2) | (0<<DDE1) | (0<<DDE0);
    PORTE=(0<<PORTE7) | (0<<PORTE6) | (0<<PORTE5) | (0<<PORTE4) | (0<<PORTE3) | (0<<PORTE2) | (0<<PORTE1) | (0<<PORTE0);
    DDRF=(0<<DDF7) | (0<<DDF6) | (0<<DDF5) | (0<<DDF4) | (0<<DDF3) | (0<<DDF2) | (0<<DDF1) | (0<<DDF0);
    PORTF=(0<<PORTF7) | (0<<PORTF6) | (0<<PORTF5) | (0<<PORTF4) | (0<<PORTF3) | (0<<PORTF2) | (0<<PORTF1) | (0<<PORTF0);
    UCSR0A=(0<<RXC0) | (0<<TXC0) | (0<<UDRE0) | (0<<FE0) | (0<<DOR0) | (0<<UPE0) | (0<<U2X0) | (0<<MPCM0);
    UCSR0B=(0<<RXCIE0) | (0<<TXCIE0) | (0<<UDRIE0) | (1<<RXEN0) | (1<<TXEN0) | (0<<UCSZ02) | (0<<RXB80) | (0<<TXB80);
    UCSR0C=(0<<UMSEL0) | (0<<UPM01) | (0<<UPM00) | (0<<USBS0) | (1<<UCSZ01) | (1<<UCSZ00) | (0<<UCPOL0);
    UBRR0H=0x00;
    UBRR0L=0x33; // 9600 Baud Rate for 8MHz clock
    MCUCSR = (1 << JTD);
    MCUCSR = (1 << JTD);
    glcd_init_data.font=font5x7;
    glcd_init_data.readxmem=NULL;
    glcd_init_data.writexmem=NULL;
    glcd_init(&glcd_init_data);
    glcd_setfont(font5x7);
    // --- ÇíÇä ÈÎÔ ãŞÏÇÑÏåí Çæáíå ---

    glcd_clear();
    glcd_outtextxy(0, 0, "Module Init...");
    delay_ms(1000);

    // 1. ÎÇãæÔ ˜ÑÏä Ç˜æ
    send_at_command("ATE0");
    delay_ms(500);

    // 2. ÊäÙíã ÍÇáÊ íÇã˜ Èå TEXT
    send_at_command("AT+CMGF=1");
    delay_ms(500);

    // 3. ÊäÙíã ãÇæá ÈÑÇí ÇÑÓÇá ãÓÊŞíã íÇã˜ Èå æÑÊ ÓÑíÇá
    send_at_command("AT+CNMI=2,2,0,0,0");
    delay_ms(500);
    
    // 4. ÍĞİ ÊãÇã íÇã˜ åÇí ŞÈáí ÈÑÇí ÇØãíäÇä
    send_at_command("AT+CMGDA=\"DEL ALL\"");
    delay_ms(2000);

    glcd_clear();
    glcd_outtextxy(0, 0, "System Ready.");
    glcd_outtextxy(0, 10, "Waiting for SMS...");  
    
    char header_buffer[100];
    char content_buffer[100];

    // ÍáŞå ÇÕáí ÈÑäÇãå
    while (1)
    {
        // åãíÔå ÂãÇÏå ÏÑíÇİÊ ÎØ Çæá (åÏÑ) ÈÇÔ
        memset(header_buffer, 0, sizeof(header_buffer));

        // ÇÑ ÎØí ÏÑíÇİÊ ÔÏ...
        if (gets(header_buffer, sizeof(header_buffer)))
        {
            // İæÑÇğ ˜ ˜ä ˜å ÂíÇ Çíä ÎØ¡ åãÇä åÏÑ íÇã˜ ÇÓÊ¿
            if (strstr(header_buffer, "+CMT:") != NULL)
            {
                // ÇÑ åÏÑ ÈæÏ¡ ÈÏæä åí ˜ÇÑ ÇÖÇİåÇí¡ ÈáÇİÇÕáå ÎØ ÈÚÏí (ãÍÊæÇ) ÑÇ ÈÎæÇä
                // Çíä ˜ÇÑ ÇÒ ÓÑÑíÒ ÔÏä ÈÇİÑ ÌáæíÑí ãí˜äÏ
                memset(content_buffer, 0, sizeof(content_buffer));
                gets(content_buffer, sizeof(content_buffer)); 

                // ÍÇáÇ ˜å åÑ Ïæ ÎØ ÏÑ ãÊÛíÑåÇí ãÇ Çãä åÓÊäÏ¡ ÈÇ ÎíÇá ÑÇÍÊ Ñæí äãÇíÔÑ äÔÇäÔÇä ÈÏå
                glcd_clear();
                glcd_outtextxy(0, 5, "From:");
                glcd_outtextxy(0, 18, header_buffer); // äãÇíÔ åÏÑ
                
                glcd_outtextxy(0, 35, "Content:");
                glcd_outtextxy(0, 48, content_buffer); // äãÇíÔ ãÍÊæÇ
                
                // äÏ ËÇäíå íÇã ÑÇ äå ÏÇÑ ÊÇ ÎæÇäÏå ÔæÏ
                delay_ms(10000); 
                
                // ÕİÍå ÑÇ ÈÑÇí íÇã ÈÚÏí ÂãÇÏå ˜ä
                glcd_clear();
                glcd_outtextxy(0, 0, "System Ready.");
                glcd_outtextxy(0, 10, "Waiting for SMS...");
            }
        }
    }
}